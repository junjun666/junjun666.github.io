<!DOCTYPE html><html><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"><meta name="author" content="John Doe"><link rel="icon" href="/hexo.png"><title>Hexo</title><meta name="description"><link rel="alternate" type="application/rss+xml" title="Hexo" href="/atom.xml"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="stylesheet" href="//cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/css/highlight.css"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class="container-fluid"><div class="navbar-header"><button type="button" data-toggle="collapse" data-target="#main-navbar" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand">Hexo</a></div><div id="main-navbar" class="collapse navbar-collapse"><ul class="nav navbar-nav navbar-right"><li><a href="/archives">Archive</a></li><li><a href="https://github.com/junjun666/junjun666.github.io">Github</a></li><li><a href="/about/">About</a></li></ul></div><div class="avatar-container"><div class="avatar-img-border"><a href="/"><img src="/hexo.png" class="avatar-img"></a></div></div></div></nav><header class="header-section"><div class="intro-header no-img"><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class="post-heading"><h1>跨域问题的解决方案</h1><p class="post-meta">Posted on Aug 13 2019</p></div></div></div></div></div></header><div class="container"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role="main" class="blog-post"><p>方法一：Jsonp 需要目标服务器配合一个callback函数</p>
<p>它的基本思想是:网页通过添加一个script元素，向服务器请求JSON数据，这种做法不受同源政策限制；服务器收到请求后，将数据放在一个指定名字的回调函数里传回来。 </p>
<p>1)首先，网页动态插入script元素，由它向跨源网址发出请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">//Js 客户端 方法一</span><br><span class="line">&lt;meta content=&quot;text/html; charset=utf-8&quot; http-equiv=&quot;Content-Type&quot; /&gt;  </span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;  </span><br><span class="line">    function jsonpCallback(result) &#123;  </span><br><span class="line">        //alert(result);  </span><br><span class="line">        for(var i in result) &#123;  </span><br><span class="line">            alert(i+&quot;:&quot;+result[i]);//循环输出a:1,b:2,etc.  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">    var JSONP=document.createElement(&quot;script&quot;);  </span><br><span class="line">    JSONP.type=&quot;text/javascript&quot;;  </span><br><span class="line">    JSONP.src=&quot;http://crossdomain.com/services.php?callback=jsonpCallback&quot;;  </span><br><span class="line">    document.getElementsByTagName(&quot;head&quot;)[0].appendChild(JSONP);  </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//Js 客户端 方案二</span><br><span class="line">&lt;meta content=&quot;text/html; charset=utf-8&quot; http-equiv=&quot;Content-Type&quot; /&gt;  </span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;  </span><br><span class="line">    function jsonpCallback(result) &#123;  </span><br><span class="line">        alert(result.a);  </span><br><span class="line">        alert(result.b);  </span><br><span class="line">        alert(result.c);  </span><br><span class="line">        for(var i in result) &#123;  </span><br><span class="line">            alert(i+&quot;:&quot;+result[i]);//循环输出a:1,b:2,etc.  </span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&lt;/script&gt;  </span><br><span class="line">&lt;script type=&quot;text/javascript&quot; src=&quot;http://crossdomain.com/services.php?callback=jsonpCallback&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>2)服务端接收到请求后，返回JSON数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">//服务端返回JSON数据  </span><br><span class="line">$arr=array(&apos;a&apos;=&gt;1,&apos;b&apos;=&gt;2,&apos;c&apos;=&gt;3,&apos;d&apos;=&gt;4,&apos;e&apos;=&gt;5);  </span><br><span class="line">$result=json_encode($arr);  </span><br><span class="line">//echo $_GET[&apos;callback&apos;].&apos;(&quot;Hello,World!&quot;)&apos;;  </span><br><span class="line">//echo $_GET[&apos;callback&apos;].&quot;($result)&quot;;  </span><br><span class="line">//动态执行回调函数  </span><br><span class="line">$callback=$_GET[&apos;callback&apos;];  </span><br><span class="line">echo $callback.&quot;($result)&quot;;</span><br></pre></td></tr></table></figure></p>
<p>方法二：document.domain</p>
<p>对于主域相同而子域不同的例子，可以通过设置document.domain的办法来解决。 具体的做法是可以在<a href="http://www.a.com/a.html和http://script.a.com/b.html两个文件中分别加上" target="_blank" rel="noopener">http://www.a.com/a.html和http://script.a.com/b.html两个文件中分别加上</a> document.domain = “a.com”；然后通过a.html文件中创建一个iframe，去控制iframe的contentDocument，这样两个js文件之间就可以 “交互”了。当然这种办法只能解决主域相同而二级域名不同的情况</p>
<p><a href="http://www.a.com上的a.html" target="_blank" rel="noopener">www.a.com上的a.html</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">document.domain = &apos;a.com&apos;;</span><br><span class="line">var ifr = document.createElement(&apos;iframe&apos;);</span><br><span class="line">ifr.src = &apos;http://script.a.com/b.html&apos;;</span><br><span class="line">ifr.style.display = &apos;none&apos;;</span><br><span class="line">document.body.appendChild(ifr);</span><br><span class="line">ifr.onload = function()&#123;</span><br><span class="line">  var doc = ifr.contentDocument || ifr.contentWindow.document;</span><br><span class="line">  // 在这里操纵b.html</span><br><span class="line">  alert(doc.getElementsByTagName(&quot;h1&quot;)[0].childNodes[0].nodeValue);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>script.a.com上的b.html<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.domain = &apos;a.com&apos;;</span><br></pre></td></tr></table></figure></p>
<p>方法三：window.name</p>
<p>window 对象的name属性是一个很特别的属性，当在 frame 中加载新页面时，name 的属性值依旧保持不变。那么我们可以在页面 A中用iframe加载其他域的页面B，而页面B中用JavaScript把需要传递的数据赋值给window.name，iframe加载完成之后，此时 name 属性值可被获取到，以访问 Web 服务发送的信息。但 name 属性仅对相同域名的 frame 可访问。这意味着为了访问 name 属性，当远程 Web 服务页面被加载后，必须导航 frame 回到原始域。即页面A修改iframe的地址，将其变成同域的一个地址，然后就可以读出window.name的值了。一旦 name 属性获得，销毁 frame 。这个方式非常适合单向的数据请求，而且协议简单、安全。</p>
<p>页面B(<a href="http://www.jesse.com/data.html)代码如下：" target="_blank" rel="noopener">www.jesse.com/data.html)代码如下：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">window.name = &apos;I was there!&apos;;</span><br><span class="line">// 这里是要传输的数据，大小一般为2M，IE和firefox下可以大至32M左右</span><br><span class="line">// 数据格式可以自定义，如json、字符串</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>页面A(<a href="http://www.jack.com/index.html)代码如下" target="_blank" rel="noopener">www.jack.com/index.html)代码如下</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">var state = 0,</span><br><span class="line">  iframe = document.createElement(&apos;iframe&apos;),</span><br><span class="line">  loadfn = function() &#123;</span><br><span class="line">    if (state === 1) &#123;</span><br><span class="line">      var data = iframe.contentWindow.name; // 读取数据</span><br><span class="line">      console.log(data); //弹出&apos;I wasthere!&apos;</span><br><span class="line">      (function()&#123;</span><br><span class="line">        //获取数据以后销毁这个iframe。</span><br><span class="line">        iframe.contentWindow.document.write(&apos;&apos;);</span><br><span class="line">        iframe.contentWindow.close();</span><br><span class="line">        document.body.removeChild(iframe);</span><br><span class="line">      &#125;)();</span><br><span class="line">    &#125; else if (state === 0) &#123;</span><br><span class="line">      state = 1;</span><br><span class="line">      // 设置的代理页面使其回原始域</span><br><span class="line">      iframe.contentWindow.location = &quot;http://www.jack.com/proxy.html&quot;; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">iframe.src = &apos;http://www.jesse.com/data.html&apos;;</span><br><span class="line">if (iframe.attachEvent) &#123;</span><br><span class="line">  iframe.attachEvent(&apos;onload&apos;, loadfn);</span><br><span class="line">&#125; else &#123;</span><br><span class="line">  iframe.onload = loadfn;</span><br><span class="line">&#125;</span><br><span class="line">document.body.appendChild(iframe);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>方法四：window.postMesage</p>
<p>window.postMessage(message,targetOrigin) 方法是html5新引进的特性，可以使用它来向其它的window对象发送消息，无论这个window对象是属于同源或不同源，目前IE8+、FireFox、Chrome、Opera等浏览器都已经支持window.postMessage方法。</p>
<p>pageA(<a href="http://www.jack.com/index.html)代码如下：" target="_blank" rel="noopener">www.jack.com/index.html)代码如下：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe id=&quot;proxy&quot; src=&quot;http://www.jesse.com/index.html&quot; onload=&quot;postMsg()&quot; style=&quot;display: none&quot;&gt;&lt;/iframe&gt;</span><br><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">var obj = &#123;</span><br><span class="line">  msg: &apos;hello world&apos;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function postMsg() &#123;</span><br><span class="line">  var iframe = document.getElementById(&apos;proxy&apos;);</span><br><span class="line">  var win = iframe.contentWindow;</span><br><span class="line">  win.postMessage(obj, &apos;http://www.jesse.com&apos;);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>pageB(<a href="http://www.jesse.com/data.php)代码如下" target="_blank" rel="noopener">www.jesse.com/data.php)代码如下</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class="line">window.onmessage = function(e) &#123;</span><br><span class="line">  console.log(e.data.msg + &quot; from &quot; + e.origin);</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p>
<p>方法五：跨域资源共享（CORS）</p>
<p>原理:跨源资源共享(CORS)定义一种跨域访问的机制，可以让AJAX实现跨域访问。CORS允许一个域上的网络应用向另一个域提交跨域AJAX请求。实现此功能非常简单，只需由服务器发送一个响应标头即可。它是通过客户端+服务端协作声明的方式来确保请求安全的。服务端会在HTTP请求头中增加一系列HTTP请求参数(例如Access-Control-Allow-Origin等)，来限制哪些域的请求和哪些请求类型可以接受，而客户端在发起请求时必须声明自己的源(Orgin)，否则服务器将不予处理，如果客户端不作声明，请求甚至会被浏览器直接拦截都到不了服务端。服务端收到HTTP请求后会进行域的比较，只有同域的请求才会处理。</p>
<p>pageA(<a href="http://www.jack.com/index.html)代码如下：" target="_blank" rel="noopener">www.jack.com/index.html)代码如下：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.onreadystatechange = function()&#123;</span><br><span class="line">  if(xhr.readyState === 4 &amp;&amp; xhr.status === 200)&#123;</span><br><span class="line">    console.log(xhr.responseText);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">xhr.open(&quot;get&quot;,&quot;http://www.jesse.com/data.php&quot;);</span><br><span class="line">xhr.send(null);</span><br></pre></td></tr></table></figure></p>
<p>pageB(<a href="http://www.jesse.com/data.php)代码如下：" target="_blank" rel="noopener">www.jesse.com/data.php)代码如下：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">  header(&quot;Access-Control-Allow-Origin: http://www.jack.com&quot;);//与简单的请求相同</span><br><span class="line">  header(&quot;Access-Control-Allow-Methods: GET, POST&quot;);//允许请求的方法</span><br><span class="line">  header(&quot;Access-Control-Max-Age: 3628800&quot;); //将这个请求缓存多长时间</span><br><span class="line">  $data = array(&apos;a&apos;,&apos;b&apos;,&apos;c&apos;);//要返回的数据</span><br><span class="line">  echo json_encode($data);//输出</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure></p>
<p>方法六：WebSocket</p>
<p>web socket是一种浏览器的API，它的目标是在一个单独的持久连接上提供全双工、双向通信。(同源策略对web socket不适用)<br>web socket原理：在JS创建了web socket之后，会有一个HTTP请求发送到浏览器以发起连接。取得服务器响应后，建立的连接会使用HTTP升级从HTTP协议交换为web sockt协议。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var socket = new WebSockt(&apos;ws://www.baidu.com&apos;);</span><br><span class="line">//http-&gt;ws; https-&gt;wss</span><br><span class="line">socket.send(&apos;hello WebSockt&apos;);</span><br><span class="line">socket.onmessage = function(event)&#123;</span><br><span class="line"> var data = event.data;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>当服务器向客户端发来消息时，WebSocket会触发message事件，把返回的数据保存在event.data中</p>
<p>参考资料：<br><a href="https://blog.csdn.net/qq_40856225/article/details/81586560" target="_blank" rel="noopener">js中跨域问题详解</a><br><a href="https://blog.csdn.net/qq_31617637/article/details/72955239" target="_blank" rel="noopener">跨域问题出现原因和解决方案</a><br><a href="https://www.jb51.net/article/106780.htm" target="_blank" rel="noopener">详解Javascript几种跨域方式总结</a></p>
</article><ul class="pager blog-pager"><li class="previous"><a href="/2019/08/14/preloading/" data-toggle="tooltip" data-placement="top" title="懒加载和预加载代码示例">← 前の記事へ</a></li><li class="next"><a href="/2019/08/12/this/" data-toggle="tooltip" data-placement="top" title="this用法大盘点">次の記事へ →</a></li></ul><div id="cloud-tie-wrapper" class="cloud-tie-wrapper"></div><script src="//img1.cache.netease.com/f2e/tie/yun/sdk/loader.js"> </script><script>var cloudTieConfig = {
  url: document.location.href, 
  sourceId: "",
  productKey: "64d7f0abf9224be3bfdcc6cfb9b83fcf",
  target: "cloud-tie-wrapper"
};</script></div></div></div><footer><div class="container beautiful-jekyll-footer"><div class="row"><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href="" title="Weibo"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-weibo"></i></span></a></li><li><a href="https://github.com/junjun666" title="GitHub"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-github"></i></span></a></li><li><a href="/atom.xml" title="RSS"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-rss"></i></span></a></li><li><a href="" title="Twitter"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-twitter"></i></span></a></li><li><a href="" title="Email me"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i><i class="fa fa-stack-1x fa-inverse fa-envelope"></i></span></a></li></ul><p class="copyright text-muted">© John Doe • 2019 • <a href="mailto:undefined"></a>
</p><p class="theme-by text-muted">Theme by
<a href="https://github.com/twoyao/beautiful-hexo">beautiful-hexo</a></p></div></div></div></footer><script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script><script src="//cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/js/main.js"></script><script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>